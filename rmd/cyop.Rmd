---
title: "King County, USA, Housing Prices"
author: "Nigel Brown"
date: "2020/10/21"
output: 
  pdf_document:
    fig_caption: yes
    toc: yes
    toc_depth: 3
    number_sections: yes
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 9, fig.width = 7)
repos <- 'https://cran.rstudio.com/'
if(!require(tidyverse)) install.packages("tidyverse", repos = repos)
if(!require(tidymodels)) install.packages("tidymodels", repos = repos)
if(!require(scales)) install.packages("scales", repos = repos)
if(!require(funModeling)) install.packages("funModeling", repos = repos)
if(!require(lubridate)) install.packages("lubridate", repos = repos)

rm(repos)

# set theme for charts
theme_set(theme_minimal())

# load the dataset 
df <- read_csv(here::here('data', 'kc_house_data.csv'))
```

# Introduction

The goal of this project is to predict house prices from the House Sales in King County, USA dataset downloaded from [kaggle](https://www.kaggle.com/harlfoxem/housesalesprediction).

The project followed the stages of:

1.  Data Exploration
2.  Cleaning the data to ready it for modeling
3.  Modeling: Linear, randomForest and xgboost
4.  Evaluating the models performance and finalizing the results

# Initial data exploration

The dataset consists of house prices in King County, Washington from observed sales between May 2014 and May 2015. The data consists of `r nrow(df)` rows of data, each row observes a single sale. There are `r ncol(df)` features in the dataset. The features are:

+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Variable                          | Description                                                                                                                                                                                                                                                                    |
+===================================+================================================================================================================================================================================================================================================================================+
| id                                | Unique ID for each sale                                                                                                                                                                                                                                                        |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| date                              | Date of the observed sale                                                                                                                                                                                                                                                      |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| price                             | Price of each house sold                                                                                                                                                                                                                                                       |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| bedrooms                          | Number of bedrooms                                                                                                                                                                                                                                                             |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| bathrooms                         | Number of bathrooms, where .5 is a room with a toilet but no with bath or shower                                                                                                                                                                                               |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sqft living                       | Square footage of the interior living space of the house                                                                                                                                                                                                                       |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sqft lot                          | Square footage of the land area the house resides on                                                                                                                                                                                                                           |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| floors                            | Number of floors                                                                                                                                                                                                                                                               |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| waterfront                        | Does the house overlook the waterfront front                                                                                                                                                                                                                                   |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| view                              | An index from 0 to 4 of how good the view of the property is                                                                                                                                                                                                                   |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| condition                         | An index from 1 to 5 on the condition of the house when sold                                                                                                                                                                                                                   |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| grade                             | An index from 1 to 13, where 1-3 have poor construction and design, 4 - 6 have below average construction and design, 7 has an average level of construction and design, 8 -11 have above average construction and design and 11 -13 have high quality construction and design |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sqrt above                        | Square footage of the interior housing space above ground level                                                                                                                                                                                                                |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sqrt basement                     | Square footage of the interior housing space below ground level                                                                                                                                                                                                                |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| yr_built                          | the year the house was built                                                                                                                                                                                                                                                   |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| yr_renovated                      | the year of the house's last renovation                                                                                                                                                                                                                                        |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| zipcode                           | the area zip code where the house is situated                                                                                                                                                                                                                                  |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| lat                               | Latitude                                                                                                                                                                                                                                                                       |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| long                              | Longitude                                                                                                                                                                                                                                                                      |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sqft_living15                     | The square footage of the interior living space for the closest 15 neighbors                                                                                                                                                                                                   |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| sqft_lot15                        | The square footage of land for the closest 15 neighbors' houses                                                                                                                                                                                                                |
+-----------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


Price will be utilized as the outcome column for our models.

The next step is to analyze the data for missing values. For this analysis the [df_status](https://www.rdocumentation.org/packages/funModeling/versions/1.9.4/topics/df_status) function from the [funModelling](https://www.rdocumentation.org/packages/funModeling/versions/1.9.4) package is utilized.

```{r data_status, echo = FALSE}

status <- df_status(df, print_results = FALSE)
knitr::kable(status,
             caption = "Dataset status") 

```

-   **q_zeros:** quantity of zeros (p_zeros: in percent)
-   **q_inf:** quantity of infinite values (p_inf: in percent)
-   **q_na:** quantity of NA (p_na: in percent)
-   **type:** the variable type
-   **unique:** quantity of unique values

# Data Preprocessing

```{r remove_vars, include=FALSE}

remove_vars <-  status %>% filter(status$p_zeros > 0.6) %>% pull(variable)
df <- df %>% select(-one_of(remove_vars))

```
As is shown in the table above there are no instances of missing data or values being infinite, however there are a number of variables where the percentage of zeros is greater than 60%, these may not be useful for modeling and they may dramatically bias the model. Therefore For this project the decision is made to remove these variables from the dataset. The features removed are: `r remove_vars`.

Once the predominately zero columns are removed, there are `r ncol(df)` left in the dataset. The date feature is split into year and month featurres and the original date is dropped

```{r data_preporcessing}

df <- df %>% 
  mutate(year = year(date),
         month = month(date),
         age = year - yr_built) %>% 
  select(-date)
glimpse(df)
```


## Is there a month when most sales occur?

```{r month_sales, echo = FALSE}
df %>% 
  group_by(month) %>% 
  summarise(n = n(), .group = 'drop') %>% 
  ggplot(aes(month, n)) + 
  geom_col(show.legend = FALSE, fill = 'steelblue') +
  scale_x_discrete(limits = c('Jan', "Feb", "Mar", "Apr", "May",
                              "Jun", "Jul", "Aug", "Sep", "Oct",
                              "Nov", "Dec")) +
  labs(
    title = "May is the most popular for house purchases",
    x = NULL,
    y = "Number of sale transactions"
   )

```


## Which are the 10 most expensive districts based on the number of properties sold over 3 million GBP?

## Which are the 10 least expensive districts based on the number of properties under 100K GBP?

## How are properties under 100k GBP clustered ?

## Are the sales evenly spread across Greater London ?

## Which type of property sold the most ?

## Which year had the most sales

## How often do properties change ownership ?

## How are house prices distributed ?

# Methods/Analysis

The first step is to split the data into training and testing datasets. The split will be an 80/20 split with 80% of the data in the training set and the remaining 20% in the test set. The split of the data will be stratified by district, to ensure that the number of data points in the training data is equivalent to the proportions in the original data set.

```{r split_data, echo = FALSE, warning = FALSE}
# Set the random number stream using `set.seed()` so that the results can be 
# reproduced later. 
set.seed(1234, sample.kind = 'Rounding')

# Save the split information for an 80/20 split of the data, stratifying on price

```

# Results

# Conclusion
