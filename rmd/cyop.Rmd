---
title: "Choose your own project submission"
author: "Nigel Brown"
date: "10/7/2020"
output: 
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
repos <- 'https://cran.rstudio.com/'
if(!require(tidyverse)) install.packages("tidyverse", repos = repos)
if(!require(tidymodels)) install.packages("tidymodels", repos = repos)
if(!require(scales)) install.packages("scales", repos = repos)

rm(repos)
# set theme for charts
theme_set(theme_minimal())

# load the dataset lhd
lhd <- read_rds(here::here('data', 'lhd.rds'))
```

# Introduction

The goal of this project is to predict house prices in the Greater London Area based on the type of property and the area of London that the property resides in.

The dataset for the project is made from data sourced from [HM Land Registry](https://www.gov.uk/government/statistical-data-sets/price-paid-data-downloads) and [FreeMapTools](https://www.freemaptools.com/download-uk-postcode-lat-lng.htm). This data has been pre-processed into a dataset titled lhd.rds. The data chosen is from a 10 year period 2009-2019. The reason 2020 has been left out of the data is that is an incomplete year at the time of analysis. The data contains 4 different types of property detached; flats/maisonettes; semi-detached and terraced. It doesn't contain number of rooms or the area squared of the property, however some feature engineering is performed to try to improve results and enhance the data.

The price paid data set from the HM Land Registry is joined together with spatial data to add latitude and longitude for the properties based on their postcodes. This will allow for mapping of the data.

# Data Wrangling

As a first step data, that is in logical form (true/false) is converted into integers 1 or 0. Next all columns containing character data are factorized.
Next a new feature is created based on the outward code contained in a postcode i.e the sub-district and another feature containing the number of times a property was observed to be sold in the 10 year time period is added.

```{r data_wrangling, echo = FALSE}

cols <- sapply(lhd, is.logical)
lhd[,cols] <- lapply(lhd[,cols], as.integer)
cols <- sapply(lhd, is.character)
lhd[,cols] <- lapply(lhd[,cols], as.factor)

# clean up 
rm(cols)

# create outward_code feature
lhd <- lhd %>% 
  mutate(outward_code = as.factor(substr(postcode, 1, 3))) %>% 
  select(-trans_date)

# create number of times sold feature
sum_price <- lhd %>% 
  group_by(address) %>% 
  summarise(num_of_sales = n(), .groups = 'drop')

lhd <- inner_join(lhd, sum_price, by = 'address')

```
# Exploritory Data Analysis

Now that the dataset is cleaned, an exploration of the data is performed. The data consists of `r nrow(lhd)` rows of data, each row observes a single sale. The are `r ncol(lhd)` features in the dataset, with price being the outcome feature.

First the price movement for each property type is plotted 

```{r prices_detached, echo = FALSE}
lhd %>% 
  filter(transaction_year %in% c("2009", "2019") & property_type == "D") %>% 
  ggplot(aes(district, price)) +
  geom_boxplot(aes(color = district), show.legend = FALSE) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) + 
  scale_y_log10(labels = comma) +
  facet_wrap(~transaction_year, nrow = 2) +
  labs(
    title = "Movement of detached house prices per district 2009 - 2019",
    subtitle = "The spread of prices in Hounslow and Westminster has narrowed,
    while in Kensington and Chelsea it has widened",
    x = NULL,
    y = "Price (log10)",
    caption = 'Contains HM Land Registry data © Crown copyright and database right 2020.'
  )

```


```{r prices_flats, echo = FALSE}
lhd %>% 
  filter(transaction_year %in% c("2009", "2019") & property_type == "F") %>% 
  ggplot(aes(district, price)) +
  geom_boxplot(aes(color = district), show.legend = FALSE) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) + 
  scale_y_log10(labels = comma) +
  facet_wrap(~transaction_year, nrow = 2) +
  labs(
    title = "Movement of flat/masonette prices per district 2009 - 2019",
    subtitle = "Camden & Kensigton and Chelsea have seen the largest price growth",
    x = NULL,
    y = "Price (log10)",
    caption = 'Contains HM Land Registry data © Crown copyright and database right 2020.'
  )
```

```{r prices_semi, echo = FALSE}
lhd %>% 
  filter(transaction_year %in% c("2009", "2019") & property_type == "S") %>% 
  ggplot(aes(district, price)) +
  geom_boxplot(aes(color = district), show.legend = FALSE) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) + 
  scale_y_log10(labels = comma) +
  facet_wrap(~transaction_year, nrow = 2) +
  labs(
    title = "Movement of semi-detached house prices per district 2009 - 2019",
    subtitle = "Kensington and Chelsea has the biggest jump in prices",
    x = NULL,
    y = "Price (log10)",
    caption = 'Contains HM Land Registry data © Crown copyright and database right 2020.'
  )
```

```{r prices_terraced, echo = FALSE}
lhd %>% 
  filter(transaction_year %in% c("2009", "2019") & property_type == "T") %>% 
  ggplot(aes(district, price)) +
  geom_boxplot(aes(color = district), show.legend = FALSE) +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5)) + 
  scale_y_log10(labels = comma) +
  facet_wrap(~transaction_year, nrow = 2) +
  labs(
    title = "Movement of terraced house prices per district 2009 - 2019",
    subtitle = "The price increase has been similar across all districts",
    x = NULL,
    y = "Price (log10)",
    caption = 'Contains HM Land Registry data © Crown copyright and database right 2020.'
  )
```


## How does the avg price increase year on year ?
```{r avg_price_yoy, echo=FALSE}
lhd %>% 
  mutate(property_type = 
           case_when(property_type == 'T' ~ "Terraced",
                     property_type == 'D' ~ "Detached",
                     property_type == 'S' ~ "Semi-Detached",
                     property_type == 'F' ~ "Flat/Maisonette",
                     property_type == 'O' ~ "Other")) %>% 
  group_by(transaction_year, property_type) %>% 
  summarise(avg_price = mean(price), .groups = 'drop') %>% 
  ggplot(aes(transaction_year, avg_price, color= property_type)) + 
  geom_line(alpha = 0.7, size = 1.5 )+
  geom_point() +
  scale_y_continuous(labels = comma) + 
  scale_x_continuous(breaks= pretty_breaks()) + 
  theme(legend.position = "top")  +
  labs(
    title = "The increase average housing cost by type in Greater London",
    subtitle = "A distinct slowdown in the increase since 2017",
    x = "Year",
    y = "Average sales price GBP",
    caption = 'Contains HM Land Registry data © Crown copyright and database right 2020.')
```

# Methods/Analysis

# Results

# Conclusion


# Disclaimers

Contains HM Land Registry data © Crown copyright and database right 2020. This data is licensed under the [Open Government Licence v3.0](http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/)


**FreeMapTools**

Contains Ordnance Survey data © Crown copyright and database right 2020.

Contains Royal Mail data © Royal Mail copyright and database right 2020.

Source: Office for National Statistics licensed under the [Open Government Licence v3.0](http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/)

# Appendix
